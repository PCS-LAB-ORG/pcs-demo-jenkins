// Kaniko demo from CloudBees site: https://docs.cloudbees.com/docs/cloudbees-ci-kb/latest/cloudbees-ci-on-modern-cloud-platforms/what-you-need-to-know-when-using-kaniko-from-kubernetes-jenkins-agents

// BEGIN PIPELINE SCRIPT
pipeline {

// Specify build agent to use. In this case a Kubernetes agent using the kaniko executer for a docker image build. Specify the agent using a label parameter instead of a type.
  agent {label 'kaniko'}
 
  stages {
    stage('Build with Kaniko') {
      environment {
        PATH = "/busybox:/kaniko:$PATH"
      }
      steps {
        container(name: 'kaniko', shell: '/busybox/sh') {

        // Create a Dockerfile
          writeFile file: "Dockerfile",
              text: """
                FROM jenkins/agent
                MAINTAINER CloudBees Support Team <support@cloudbees.com>
                RUN mkdir /home/jenkins/.m2
              """

          sh 'ls -lsah'

/* COMMENT OUT TO TROUBLESHOOT
        // Write Docker Credentials to a file
        withCredentials([file(credentialsId: 'bgoldstein-dockerhub-cred', variable: 'DOCKER_CONFIG_JSON')]) {
                sh '''#!/busybox/sh
                    cp \$DOCKER_CONFIG_JSON /kaniko/.docker/config.json
                    '''
                }

        // Build the docker image using Kaniko
          sh '''#!/busybox/sh
            /kaniko/executor --context `pwd` --verbosity debug --destination bgpanw/cloudbees:latest
          '''
END COMMENT TO TROUBLESHOOT
*/

// END CONTAINER
          }

// END STEPS for Build with Kaniko
            }

// END STAGE Build with Kaniko
    }

// END ALL STAGES
      }  

// END PIPELINE
}
